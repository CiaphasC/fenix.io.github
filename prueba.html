import React, { useEffect, useRef, useState, useLayoutEffect, useContext } from 'react';
import * as THREE from 'three';
import { 
  ArrowUpRight, 
  Target, 
  Users, 
  TrendingUp, 
  ShieldCheck, 
  Clock, 
  Menu,
  X,
  ChevronRight
} from 'lucide-react';

// --- GSAP CONTEXT & LOADER ---
// Contexto para notificar a los componentes cuando GSAP está listo
const GsapContext = React.createContext(false);

const useGsapLoader = () => {
  const [ready, setReady] = useState(false);

  useEffect(() => {
    // Si ya está cargado globalmente
    if (window.gsap && window.ScrollTrigger) {
      window.gsap.registerPlugin(window.ScrollTrigger);
      setReady(true);
      return;
    }

    // Cargar GSAP Core
    const script1 = document.createElement('script');
    script1.src = "https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/gsap.min.js";
    script1.async = true;
    
    script1.onload = () => {
      // Cargar ScrollTrigger después del Core
      const script2 = document.createElement('script');
      script2.src = "https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/ScrollTrigger.min.js";
      script2.async = true;
      
      script2.onload = () => {
        if (window.gsap && window.ScrollTrigger) {
          window.gsap.registerPlugin(window.ScrollTrigger);
          setReady(true);
        }
      };
      
      document.body.appendChild(script2);
    };

    document.body.appendChild(script1);

    return () => {
      // Cleanup opcional
    };
  }, []);

  return ready;
};

// --- COMPONENTES DE ANIMACIÓN ---

// 1. Componente para animar números (Counter)
const AnimatedCounter = ({ end, suffix = "", prefix = "", duration = 2 }) => {
  const ref = useRef(null);
  const isGsapReady = useContext(GsapContext);

  useEffect(() => {
    if (!isGsapReady || !ref.current) return;
    const gsap = window.gsap;

    gsap.fromTo(ref.current, 
      { innerText: 0 }, 
      {
        innerText: end,
        duration: duration,
        ease: "power2.out",
        snap: { innerText: 0.1 }, 
        scrollTrigger: {
          trigger: ref.current,
          start: "top 85%",
          once: true
        },
        onUpdate: function() {
          const val = this.targets()[0].innerText;
          ref.current.innerText = prefix + parseFloat(val).toFixed(end % 1 === 0 ? 0 : 1) + suffix;
        }
      }
    );
  }, [isGsapReady, end, suffix, prefix, duration]);

  return <span ref={ref}>{prefix}0{suffix}</span>;
};

// 2. Wrapper para revelación suave al hacer scroll
const Reveal = ({ children, delay = 0, className = "", direction = "y", distance = 50 }) => {
  const ref = useRef(null);
  const isGsapReady = useContext(GsapContext);

  useLayoutEffect(() => {
    if (!isGsapReady || !ref.current) return;
    const gsap = window.gsap;

    let fromVars = { opacity: 0, duration: 1.2, ease: "power3.out", delay: delay };
    
    if (direction === "y") fromVars.y = distance;
    if (direction === "x") fromVars.x = distance;
    if (direction === "-x") fromVars.x = -distance;

    const ctx = gsap.context(() => {
      gsap.fromTo(ref.current, 
        fromVars,
        {
          opacity: 1,
          x: 0,
          y: 0,
          scrollTrigger: {
            trigger: ref.current,
            start: "top 85%", 
            toggleActions: "play none none reverse" 
          }
        }
      );
    });

    return () => ctx.revert();
  }, [isGsapReady, delay, direction, distance]);

  return <div ref={ref} className={`${className} ${!isGsapReady ? 'opacity-0' : ''}`}>{children}</div>;
};

// --- THREE.JS: PREMIUM INTERACTIVE FLUID PARTICLES ---
const PremiumBackground = () => {
  const mountRef = useRef(null);

  useEffect(() => {
    if (!mountRef.current) return;

    // 1. Setup
    const scene = new THREE.Scene();
    scene.fog = new THREE.FogExp2(0xffffff, 0.001); 
    
    const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
    camera.position.z = 100;

    const renderer = new THREE.WebGLRenderer({ alpha: true, antialias: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
    mountRef.current.appendChild(renderer.domElement);

    // 2. Geometry
    const particleCount = 1200;
    const geometry = new THREE.BufferGeometry();
    const positions = new Float32Array(particleCount * 3);
    const originalPositions = new Float32Array(particleCount * 3);
    const scales = new Float32Array(particleCount);

    for (let i = 0; i < particleCount; i++) {
      const i3 = i * 3;
      positions[i3] = (Math.random() - 0.5) * 200; 
      positions[i3 + 1] = (Math.random() - 0.5) * 100; 
      positions[i3 + 2] = (Math.random() - 0.5) * 100; 
      
      originalPositions[i3] = positions[i3];
      originalPositions[i3 + 1] = positions[i3 + 1];
      originalPositions[i3 + 2] = positions[i3 + 2];

      scales[i] = Math.random();
    }

    geometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));
    geometry.setAttribute('scale', new THREE.BufferAttribute(scales, 1));

    // 3. Texture
    const canvas = document.createElement('canvas');
    canvas.width = 32;
    canvas.height = 32;
    const context = canvas.getContext('2d');
    if (context) {
        const gradient = context.createRadialGradient(16, 16, 0, 16, 16, 16);
        gradient.addColorStop(0, 'rgba(160, 136, 112, 1)'); 
        gradient.addColorStop(1, 'rgba(160, 136, 112, 0)'); 
        context.fillStyle = gradient;
        context.fillRect(0, 0, 32, 32);
    }
    const texture = new THREE.CanvasTexture(canvas);

    const material = new THREE.PointsMaterial({
      color: 0xA08870,
      size: 1.5,
      map: texture,
      transparent: true,
      opacity: 0.8,
      depthWrite: false,
      blending: THREE.NormalBlending,
      sizeAttenuation: true
    });

    const particles = new THREE.Points(geometry, material);
    scene.add(particles);

    // 4. Interaction
    let mouseX = 0;
    let mouseY = 0;
    let targetX = 0;
    let targetY = 0;

    const handleMouseMove = (event) => {
      mouseX = (event.clientX / window.innerWidth) * 2 - 1;
      mouseY = -(event.clientY / window.innerHeight) * 2 + 1;
    };

    window.addEventListener('mousemove', handleMouseMove);

    // 5. Animation
    const clock = new THREE.Clock();

    const animate = () => {
      requestAnimationFrame(animate);
      const elapsedTime = clock.getElapsedTime();

      targetX = mouseX * 5;
      targetY = mouseY * 5;
      camera.position.x += (targetX - camera.position.x) * 0.05;
      camera.position.y += (targetY - camera.position.y) * 0.05;
      camera.lookAt(scene.position);

      const positions = particles.geometry.attributes.position.array;

      for (let i = 0; i < particleCount; i++) {
        const i3 = i * 3;
        const x = originalPositions[i3];
        const y = originalPositions[i3 + 1];
        
        // Wave
        const movementY = Math.sin(elapsedTime * 0.5 + x * 0.05) * 5; 
        const movementX = Math.cos(elapsedTime * 0.3 + y * 0.05) * 2;
        
        positions[i3] = originalPositions[i3] + movementX;
        positions[i3 + 1] = originalPositions[i3 + 1] + movementY;

        // Interaction
        const mouseWorldX = mouseX * 100;
        const mouseWorldY = mouseY * 50;
        
        const dx = mouseWorldX - positions[i3];
        const dy = mouseWorldY - positions[i3 + 1];
        const dist = Math.sqrt(dx * dx + dy * dy);
        
        if (dist < 30) {
            const force = (30 - dist) / 30;
            const angle = Math.atan2(dy, dx);
            positions[i3] -= Math.cos(angle) * force * 5; 
            positions[i3 + 1] -= Math.sin(angle) * force * 5; 
        }
      }

      particles.geometry.attributes.position.needsUpdate = true;
      particles.rotation.y = elapsedTime * 0.05;

      renderer.render(scene, camera);
    };

    animate();

    // 6. Resize
    const handleResize = () => {
      camera.aspect = window.innerWidth / window.innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth, window.innerHeight);
    };
    window.addEventListener('resize', handleResize);

    return () => {
      window.removeEventListener('mousemove', handleMouseMove);
      window.removeEventListener('resize', handleResize);
      if (mountRef.current && renderer.domElement) {
        mountRef.current.removeChild(renderer.domElement);
      }
      geometry.dispose();
      material.dispose();
    };
  }, []);

  return <div ref={mountRef} className="fixed inset-0 z-0 pointer-events-none opacity-60" />;
};

// --- MAIN APP ---
export default function App() {
  const [isMenuOpen, setIsMenuOpen] = useState(false);
  const mainRef = useRef(null); 
  
  // Usar custom hook para cargar scripts
  const isGsapReady = useGsapLoader();

  // --- ANIMACIÓN PRINCIPAL (CORTINA + HERO) ---
  useLayoutEffect(() => {
    if (!isGsapReady || !mainRef.current) return;
    const gsap = window.gsap;

    const ctx = gsap.context(() => {
      const tl = gsap.timeline();
      
      // 1. Fase de Cortina (Pre-Loader)
      tl.to(".curtain-text", {
        opacity: 1,
        y: 0,
        duration: 1,
        ease: "power2.out"
      })
      .to(".curtain-text", {
        opacity: 0,
        y: -20,
        duration: 0.6,
        delay: 0.3,
        ease: "power2.in"
      })
      .to(".curtain-panel", {
        height: 0,
        duration: 1.5,
        stagger: 0.1, // Pequeño retraso entre la capa gris y la dorada
        ease: "power4.inOut"
      })
      
      // 2. Fase Hero (Integrada justo después de la cortina)
      // Usamos "-=1.0" para que empiece un poco antes de que termine de subir la cortina por completo
      .from(".nav-item", { 
        y: -20, 
        opacity: 0, 
        duration: 0.8, 
        stagger: 0.1, 
        ease: "power3.out" 
      }, "-=0.8")
      .from(".hero-line", {
        scaleX: 0,
        transformOrigin: "left center",
        duration: 0.8, 
        ease: "expo.out"
      }, "-=0.6")
      .from(".hero-title-line", {
        y: 100,
        opacity: 0,
        rotateX: -20,
        duration: 1.2,
        stagger: 0.15,
        ease: "power4.out"
      }, "-=0.7")
      .from(".hero-desc", {
        x: -20,
        opacity: 0,
        duration: 1,
        ease: "power2.out"
      }, "-=0.8")
      .from(".hero-btn", {
        y: 20,
        opacity: 0,
        duration: 0.8,
        ease: "back.out(1.7)"
      }, "-=0.8")
      .from(".hero-stat", {
        opacity: 0,
        x: 20,
        stagger: 0.2,
        duration: 1
      }, "-=1");

    }, mainRef);

    return () => ctx.revert();
  }, [isGsapReady]);

  const services = [
    { 
      id: "01", 
      title: "Reestructuración Estratégica", 
      desc: "Análisis forense de quiebra y diseño de nueva arquitectura empresarial.",
      icon: <Target className="text-gray-900" size={20} />
    },
    { 
      id: "02", 
      title: "Auditoría de Riesgo & Blindaje", 
      desc: "Protocolos de seguridad financiera para prevenir futuros colapsos.",
      icon: <ShieldCheck className="text-gray-900" size={20} />
    },
    { 
      id: "03", 
      title: "Alta Dirección & Vida", 
      desc: "Metodología propietaria para integrar maternidad en roles de C-Level.",
      icon: <Users className="text-gray-900" size={20} />
    },
    { 
      id: "04", 
      title: "Escalabilidad Sostenible", 
      desc: "Sistemas de crecimiento validados para facturación recurrente.",
      icon: <TrendingUp className="text-gray-900" size={20} />
    },
  ];

  return (
    <GsapContext.Provider value={isGsapReady}>
      <div ref={mainRef} className="bg-white text-gray-900 font-sans min-h-screen selection:bg-[#E5D4C0] selection:text-gray-900 overflow-x-hidden">
        
        {/* --- CURTAIN REVEAL OVERLAY --- */}
        <div className="fixed inset-0 z-[100] pointer-events-none flex flex-col items-center justify-center">
          {/* Capa Principal (Gris Oscura) */}
          <div className="curtain-panel absolute inset-0 bg-[#1a1a1a] z-20 flex items-center justify-center">
              <h1 className="curtain-text text-4xl md:text-6xl font-serif text-[#A08870] opacity-0 translate-y-10 tracking-widest">
                  FENIX<span className="font-light text-white">360</span>
              </h1>
          </div>
          {/* Capa Secundaria (Color Acento) - Se mueve ligeramente después para dar profundidad */}
          <div className="curtain-panel absolute inset-0 bg-[#A08870] z-10" />
        </div>

        <PremiumBackground />

        {/* --- HEADER / NAV --- */}
        <nav className="fixed top-0 w-full z-50 border-b border-gray-100 bg-white/90 backdrop-blur-md">
          <div className="max-w-[1400px] mx-auto px-6 h-20 flex justify-between items-center">
            <div className="nav-item text-2xl font-serif tracking-tight text-gray-900 cursor-pointer">
              FENIX<span className="text-[#A08870] font-light">360</span>
            </div>
            
            <div className="hidden md:flex gap-10 text-xs font-medium tracking-[0.15em] text-gray-500 uppercase">
              <a href="#manifiesto" className="nav-item hover:text-gray-900 transition-colors">Manifiesto</a>
              <a href="#trayectoria" className="nav-item hover:text-gray-900 transition-colors">Trayectoria</a>
              <a href="#consultoria" className="nav-item hover:text-gray-900 transition-colors">Consultoría</a>
            </div>

            <div className="flex items-center gap-6">
              <button className="nav-item hidden md:flex items-center gap-2 text-xs font-bold uppercase tracking-wider bg-gray-900 text-white px-6 py-3 hover:bg-[#A08870] transition-all duration-300 transform hover:-translate-y-1 hover:shadow-lg">
                Agenda Privada
              </button>
              <button className="md:hidden text-gray-900" onClick={() => setIsMenuOpen(!isMenuOpen)}>
                {isMenuOpen ? <X /> : <Menu />}
              </button>
            </div>
          </div>
        </nav>

        {/* --- HERO SECTION (EDITORIAL STYLE) --- */}
        <section className="relative min-h-screen flex items-center pt-20 px-6">
          <div className="max-w-[1400px] mx-auto w-full grid grid-cols-1 lg:grid-cols-12 gap-12 items-end">
            
            <div className="lg:col-span-8 relative z-10">
              {/* Only show if ready to prevent layout shift or use opacity control */}
              <div className={`transition-opacity duration-500 ${isGsapReady ? 'opacity-100' : 'opacity-0'}`}>
                <div className="hero-line w-fit overflow-hidden mb-8">
                  <div className="inline-block px-3 py-1 border border-[#A08870]/40 text-[#A08870] text-[10px] font-bold tracking-[0.2em] uppercase">
                    Consultoría de Alto Nivel
                  </div>
                </div>
              
                <div className="overflow-hidden">
                  <h1 className="text-5xl md:text-6xl lg:text-7xl font-serif leading-[1.0] text-gray-900 mb-8 tracking-tight">
                    <div className="hero-title-line">El arte de</div>
                    <div className="hero-title-line"><span className="italic text-gray-500 font-light">renacer</span> con</div>
                    <div className="hero-title-line">autoridad.</div>
                  </h1>
                </div>
                
                <div className="hero-desc max-w-xl border-l border-[#A08870] pl-6 ml-2">
                  <p className="text-lg text-gray-600 font-light leading-relaxed">
                    Transformamos crisis empresariales en legados sólidos. 
                    Metodología exclusiva para empresarias que integran 
                    facturación de alto nivel con una vida personal plena.
                  </p>
                </div>

                <div className="hero-btn mt-12 flex flex-col sm:flex-row gap-6">
                  <button className="group flex items-center gap-4 text-sm uppercase tracking-widest text-gray-900 border-b border-gray-900 pb-2 hover:text-[#A08870] hover:border-[#A08870] transition-all w-fit font-medium">
                    Ver Caso de Estudio <ArrowUpRight className="group-hover:-translate-y-1 group-hover:translate-x-1 transition-transform" size={16} />
                  </button>
                </div>
              </div>
            </div>

            <div className="lg:col-span-4 flex flex-col justify-end items-end text-right relative z-10">
                <div className={`hero-stat mb-12 transition-opacity duration-500 ${isGsapReady ? 'opacity-100' : 'opacity-0'}`}>
                  <div className="text-5xl font-light text-gray-900 mb-2 font-serif flex justify-end">
                    <AnimatedCounter prefix="$" end={280} suffix="k" />
                  </div>
                  <div className="text-xs text-gray-400 uppercase tracking-widest font-medium">Facturación Auditada 2024</div>
                </div>
                <div className={`hero-stat transition-opacity duration-500 ${isGsapReady ? 'opacity-100' : 'opacity-0'}`}>
                  <div className="text-5xl font-light text-[#A08870] mb-2 font-serif flex justify-end">
                    <AnimatedCounter end={1.7} suffix=" Años" />
                  </div>
                  <div className="text-xs text-gray-400 uppercase tracking-widest font-medium">Tiempo de Reconstrucción</div>
                </div>
            </div>
          </div>
        </section>

        {/* --- GRID LAYOUT SERVICES --- */}
        <section id="consultoria" className="py-32 px-6 border-t border-gray-100 bg-white relative z-10">
          <div className="max-w-[1400px] mx-auto">
            <Reveal>
              <div className="flex flex-col md:flex-row justify-between items-end mb-16">
                <h2 className="text-3xl md:text-5xl font-serif text-gray-900">
                  Soluciones Ejecutivas
                </h2>
                <a href="#" className="hidden md:block text-xs uppercase tracking-widest text-gray-400 hover:text-gray-900 transition-colors font-medium">
                  Explorar todos los servicios &rarr;
                </a>
              </div>
            </Reveal>

            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 border-t border-l border-gray-100">
              {services.map((service, index) => (
                <Reveal key={service.id} delay={index * 0.1} className="h-full">
                  <div 
                    className="group relative p-10 border-r border-b border-gray-100 hover:bg-gray-50 transition-colors duration-500 min-h-[300px] flex flex-col justify-between h-full"
                  >
                    <div>
                      <div className="flex justify-between items-start mb-8">
                        <span className="text-xs font-mono text-gray-400">{service.id}</span>
                        <div className="opacity-0 group-hover:opacity-100 transition-opacity duration-300 transform group-hover:rotate-45">
                          <ArrowUpRight size={18} className="text-[#A08870]" />
                        </div>
                      </div>
                      <h3 className="text-xl font-serif text-gray-900 mb-4 group-hover:text-[#A08870] transition-colors">{service.title}</h3>
                      <p className="text-sm text-gray-500 font-light leading-relaxed">
                        {service.desc}
                      </p>
                    </div>
                  </div>
                </Reveal>
              ))}
            </div>
          </div>
        </section>

        {/* --- MANIFESTO / STORY --- */}
        <section id="manifiesto" className="relative z-10 border-t border-gray-100 overflow-hidden">
          <div className="grid grid-cols-1 lg:grid-cols-2">
            
            {/* Left: Image / Visual */}
            <div className="relative h-[600px] lg:h-auto bg-gray-100 overflow-hidden group">
              {/* Overlay sutil */}
              <div className="absolute inset-0 bg-white/10 z-10" />
              
              {/* Animación Abstracta */}
              <div className="absolute inset-0 flex items-center justify-center opacity-30">
                <div className="w-[80%] h-[80%] border border-gray-400 rounded-full animate-spin-slow duration-[60s]"></div>
                <div className="absolute w-[60%] h-[60%] border border-gray-400 rounded-full animate-reverse-spin duration-[40s]"></div>
              </div>

              <div className="absolute bottom-12 left-12 z-20 max-w-md">
                  <Reveal direction="x" distance={-30}>
                      <div className="flex items-center gap-3 mb-4">
                          <div className="w-8 h-[1px] bg-[#A08870]"></div>
                          <span className="text-[#A08870] text-xs font-bold uppercase tracking-widest">La Fundadora</span>
                      </div>
                      <blockquote className="text-2xl font-serif text-gray-900 leading-relaxed italic">
                          "No construimos empresas para sobrevivir. Construimos para trascender a la quiebra y al tiempo."
                      </blockquote>
                  </Reveal>
              </div>
            </div>

            {/* Right: Text Content */}
            <div className="py-24 px-12 lg:px-24 flex flex-col justify-center bg-white">
              <Reveal direction="y">
                <h2 className="text-4xl md:text-5xl font-serif mb-12 text-gray-900">
                  Resiliencia <br/>
                  <span className="text-[#A08870] italic">Operativa</span>.
                </h2>
              </Reveal>
              
              <div className="space-y-8 text-gray-600 font-light text-lg leading-relaxed">
                <Reveal delay={0.1}>
                  <p>
                    El 2024 cerró con éxito. El 2025 trajo el silencio. 
                    En el mundo corporativo, la fragilidad es el costo oculto del crecimiento rápido.
                  </p>
                </Reveal>
                <Reveal delay={0.2}>
                  <p>
                    Mi retorno no fue casualidad. Fue ingeniería.
                    A los 45 años, con la complejidad de la maternidad y el matrimonio, 
                    rediseñé no solo mi modelo de negocio, sino mi modelo de vida.
                  </p>
                </Reveal>
                <Reveal delay={0.3}>
                  <div className="pt-8 border-t border-gray-100 mt-8">
                    <div className="flex items-center gap-4 text-gray-900 mb-2">
                      <Clock size={18} className="text-[#A08870]" />
                      <span className="font-serif text-xl">1 Año 7 Meses</span>
                    </div>
                    <p className="text-sm text-gray-400 uppercase tracking-widest font-medium">Tiempo récord de recuperación total</p>
                  </div>
                </Reveal>
              </div>
            </div>

          </div>
        </section>

        {/* --- QUOTE / CALL TO ACTION --- */}
        <section className="py-32 px-6 bg-gray-50 border-t border-gray-100 text-center relative z-10">
          <div className="max-w-3xl mx-auto">
            <Reveal>
              <div className="w-px h-20 bg-gradient-to-b from-transparent via-[#A08870] to-transparent mx-auto mb-12 opacity-50"></div>
              <p className="text-xl md:text-3xl font-serif text-gray-800 leading-relaxed mb-12 italic">
                "Liderar es asumir responsabilidad antes que reconocimiento. 
                Es tomar decisiones difíciles hoy para construir el futuro que quieres liderar mañana."
              </p>
              <button className="text-xs font-bold uppercase tracking-[0.2em] text-[#A08870] hover:text-gray-900 transition-colors flex items-center justify-center gap-2 mx-auto group">
                Iniciar Conversación <ChevronRight size={14} className="group-hover:translate-x-1 transition-transform" />
              </button>
            </Reveal>
          </div>
        </section>

        {/* --- FOOTER --- */}
        <footer className="py-12 px-6 border-t border-gray-100 bg-white text-gray-500 text-xs relative z-10">
          <div className="max-w-[1400px] mx-auto flex flex-col md:flex-row justify-between items-center gap-6">
            <div className="font-serif text-gray-900 font-bold">FENIX360 &copy; 2026</div>
            <div className="flex gap-8 uppercase tracking-wider font-medium">
              <a href="#" className="hover:text-gray-900 transition-colors">Legal</a>
              <a href="#" className="hover:text-gray-900 transition-colors">Privacidad</a>
              <a href="#" className="hover:text-gray-900 transition-colors">Linkedin</a>
              <a href="#" className="hover:text-gray-900 transition-colors">Instagram</a>
            </div>
          </div>
        </footer>

        {/* --- STYLES --- */}
        <style>{`
          @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600&family=Playfair+Display:ital,wght@0,400;0,500;0,600;1,400&family=Inter:wght@200;300;400;500&display=swap');
          
          body { font-family: 'Inter', sans-serif; }
          h1, h2, h3, .font-serif { font-family: 'Playfair Display', serif; }
          
          /* Smooth scrolling */
          html { scroll-behavior: smooth; }
        `}</style>
      </div>
    </GsapContext.Provider>
  );
}